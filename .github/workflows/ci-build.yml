name: CI Build and Push to DockerHub

on:
  push:
    branches: [master]

env:
  REGISTRY: docker.io
  IMAGE_NAME_FRONTEND: taskmanager-frontend
  IMAGE_NAME_BACKEND: taskmanager-backend
  INFRA_REPO: OletiSatishKumar/TaskManager_MERN_Infra

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set Build Tag
      run: echo "BUILD_TAG=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

    - name: Login to DockerHub
      run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Build and Push Frontend Image
      run: |
        docker build -t $REGISTRY/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME_FRONTEND:$BUILD_TAG ./client
        docker push $REGISTRY/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME_FRONTEND:$BUILD_TAG

    - name: Build and Push Backend Image
      run: |
        docker build -t $REGISTRY/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME_BACKEND:$BUILD_TAG ./backend
        docker push $REGISTRY/${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME_BACKEND:$BUILD_TAG

    - name: Clone Infra Repo
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git clone https://x-access-token:${{ secrets.PAT_GITHUB }}@github.com/${{ env.INFRA_REPO }}.git infra-repo

    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    - name: Update Dev Values File
      run: |
        cd infra-repo/environments/dev
        yq e '.client.image.tag = env(BUILD_TAG)' -i values-dev.yaml
        yq e '.backend.image.tag = env(BUILD_TAG)' -i values-dev.yaml

    - name: Commit and Push Update to Infra Repo
      run: |
        cd infra-repo
        git add environments/dev/dev-values.yaml
        git commit -m "Update image tags to $BUILD_TAG from CI workflow" || echo "No changes to commit"
        git push origin master
